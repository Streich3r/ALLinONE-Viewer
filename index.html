<!DOCTYPE html>
<html lang="de">
<head>
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" type="image/png" href="icon-512.png">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Offline Document Viewer</title>
<style>
body { font-family: sans-serif; padding: 20px; background-color: #0b0d12; color: #fff; }
button { margin: 5px; padding: 10px 15px; font-size: 1rem; background-color: #1f222d; color: #fff; border: 1px solid #444; border-radius: 5px; cursor: pointer; }
button:hover { background-color: #2a2e3c; }
#viewer { margin-top: 20px; border: 1px solid #444; padding: 10px; background-color: #1c1f28; color: #fff; min-height: 200px; overflow:auto; }
canvas { max-width: 100%; height: auto; display: block; margin: 0 auto; }
.slide { display:none; }
.slide img { max-width: 100%; height: auto; margin: auto; }
.nav-buttons { text-align: center; margin-top: 10px; }
</style>
</head>
<body>
<h2>Offline Document Viewer</h2>

<!-- File Inputs -->
<input type="file" id="pdfFile" accept=".pdf" style="display:none"/>
<button onclick="document.getElementById('pdfFile').click()">PDF öffnen</button>

<input type="file" id="docxFile" accept=".docx" style="display:none"/>
<button onclick="document.getElementById('docxFile').click()">Word öffnen</button>

<input type="file" id="xlsxFile" accept=".xlsx" style="display:none"/>
<button onclick="document.getElementById('xlsxFile').click()">Excel öffnen</button>

<input type="file" id="pptxFile" accept=".pptx" style="display:none"/>
<button onclick="document.getElementById('pptxFile').click()">PowerPoint öffnen</button>

<input type="file" id="odfFile" accept=".odt,.ods,.odp" style="display:none"/>
<button onclick="document.getElementById('odfFile').click()">ODF öffnen</button>

<div id="viewer">Bitte eine Datei hochladen...</div>
<div class="nav-buttons" id="pptNav" style="display:none;">
    <button id="prevSlide">← Zurück</button>
    <button id="nextSlide">Weiter →</button>
</div>

<!-- Libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.12.313/pdf.min.js"></script>
<script src="https://unpkg.com/docx-preview@0.3.1/dist/docx-preview.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://webodf.org/webodf.js"></script>

<script>
const viewer = document.getElementById('viewer');
const pptNav = document.getElementById('pptNav');
let slides = [], currentSlide = 0;

function showSlide(i){ slides.forEach((s,x)=>s.style.display = (i===x?'block':'none')); }
function showError(msg){ viewer.innerHTML = `<p style="color:#f88">⚠️ ${msg}</p>`; }

/* --- PDF --- */
pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.12.313/pdf.worker.min.js";
document.getElementById('pdfFile').addEventListener('change', async e=>{
  try {
    const buf = await e.target.files[0].arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:buf}).promise;
    const page = await pdf.getPage(1);
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const vp = page.getViewport({scale:1.2});
    canvas.width = vp.width; canvas.height = vp.height;
    await page.render({canvasContext:ctx, viewport:vp}).promise;
    viewer.innerHTML=''; viewer.appendChild(canvas); pptNav.style.display='none';
  } catch(err){ showError("PDF Fehler: "+err.message); }
});

/* --- DOCX --- */
document.getElementById('docxFile').addEventListener('change', async e=>{
  try {
    const buf = await e.target.files[0].arrayBuffer();
    viewer.innerHTML='';
    const dp = new window.DocxPreview(); 
    dp.renderAsync(buf, viewer);
    pptNav.style.display='none';
  } catch(err){ showError("DOCX Fehler: "+err.message); }
});

/* --- XLSX --- */
document.getElementById('xlsxFile').addEventListener('change', async e=>{
  try {
    const buf = await e.target.files[0].arrayBuffer();
    const wb = XLSX.read(buf,{type:"array"});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    viewer.innerHTML = XLSX.utils.sheet_to_html(sheet);
    pptNav.style.display='none';
  } catch(err){ showError("XLSX Fehler: "+err.message); }
});

/* --- PPTX --- */
document.getElementById('pptxFile').addEventListener('change', async e=>{
  try {
    const buf = await e.target.files[0].arrayBuffer();
    const zip = await JSZip.loadAsync(buf);
    viewer.innerHTML=''; slides=[];
    const slideFiles = Object.keys(zip.files).filter(f=>f.startsWith("ppt/slides/slide")&&f.endsWith(".xml")).sort();
    for(const s of slideFiles){
      const xml = await zip.files[s].async('text');
      const div=document.createElement('div'); div.className='slide';
      const texts=[...xml.matchAll(/<a:t>(.*?)<\/a:t>/g)].map(m=>m[1]);
      div.innerHTML=texts.map(t=>`<p>${t}</p>`).join('')||'(leer)';
      viewer.appendChild(div); slides.push(div);
    }
    if(slides.length){ currentSlide=0; showSlide(0); pptNav.style.display='block'; }
  } catch(err){ showError("PPTX Fehler: "+err.message); }
});
document.getElementById('prevSlide').addEventListener('click', ()=>{ if(currentSlide>0) showSlide(--currentSlide); });
document.getElementById('nextSlide').addEventListener('click', ()=>{ if(currentSlide<slides.length-1) showSlide(++currentSlide); });

/* --- ODF --- */
document.getElementById('odfFile').addEventListener('change', e=>{
  const file = e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>{
    viewer.innerHTML='';
    const c=document.createElement('div'); c.style.width="100%"; c.style.height="500px";
    viewer.appendChild(c);
    const odfCanvas=new odf.OdfCanvas(c);
    odfCanvas.load(reader.result);
    pptNav.style.display='none';
  };
  reader.readAsArrayBuffer(file);
});
</script>
</body>
</html>
