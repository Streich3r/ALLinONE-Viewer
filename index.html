<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Matrix Document Viewer</title>
<link rel="stylesheet" href="pptxjs.css">
<style>
html, body { margin:0; padding:0; height:100%; background:black; font-family: monospace; overflow:hidden; }
canvas#matrixCanvas { position:fixed; top:0; left:0; width:100%; height:100%; z-index:0; display:block; }

/* Overlay */
#overlay {
  position:absolute; top:0; left:0; width:100%; height:100%;
  backdrop-filter: blur(6px);
  background: rgba(0,0,0,0.6);
  z-index:1;
  display:flex; justify-content:center; align-items:center; flex-direction:column;
}

/* Viewer Container (Preview) */
#viewerContainer {
  display:none;
  background: rgba(0,0,0,0.85);
  border-radius:16px;
  max-width:90%;
  max-height:80%;
  overflow:hidden; /* Kein scroll, Preview passt komplett */
  justify-content:center;
  align-items:center;
  flex-direction:column;
  padding:10px;
  box-sizing: border-box;
  border:2px solid #0f0; /* Grüner Rand für Viewer */
}

/* PDF Canvas */
#pdfCanvas {
  border-radius:12px;
  border:2px solid #333; /* Dark Mode Rand */
  background:#111;
  display:none;
  box-sizing:border-box;
  margin:5px;
  width:100%;
  height:auto;
}

/* Andere Dokumente Preview */
#docOutput, #docxContainer, #odtContainer, #pptxContainer {
  border-radius:12px;
  border:2px solid #333;
  background:#111;
  color:white;
  padding:10px;
  display:none;
  box-sizing:border-box;
  margin:5px;
  width:100%;
  height:auto;
  overflow:hidden;
}

/* Upload Bar */
#uploadBar {
  position:absolute;
  bottom:20px;
  display:flex;
  justify-content:center;
  align-items:center;
  gap:10px;
  width:100%;
}

/* Datei Input */
#fileInput {
  background:#000; border:2px solid #0f0; color:#0f0;
  padding:0.8rem 1rem; border-radius:12px; font-size:1rem; cursor:pointer;
}

/* Error Box */
#errorBox {
  position:absolute; bottom:90px; background: rgba(255,0,0,0.8);
  color:white; padding:0.4rem 0.8rem; border-radius:8px;
  display:none; font-size:0.8rem;
}

/* Fullscreen Button */
#fullscreenBtn {
  position:fixed; bottom:20px; right:20px;
  background:rgba(0,0,0,0.8);
  border:2px solid #0f0;
  border-radius:50%;
  width:48px; height:48px;
  display:none; justify-content:center; align-items:center;
  cursor:pointer; color:#0f0; font-size:1.2rem; z-index:100;
}
</style>
</head>
<body>

<canvas id="matrixCanvas"></canvas>

<div id="overlay">
  <div id="viewerContainer">
    <canvas id="pdfCanvas"></canvas>
    <div id="docxContainer"></div>
    <div id="odtContainer"></div>
    <div id="pptxContainer"></div>
    <div id="docOutput"></div>
  </div>

  <div id="uploadBar">
    <input type="file" id="fileInput" />
  </div>

  <div id="errorBox"></div>
</div>

<div id="fullscreenBtn">⛶</div>

<!-- Matrix Hintergrund -->
<script>
const canvas=document.getElementById('matrixCanvas');const ctx=canvas.getContext('2d');
function resizeCanvas(){canvas.width=window.innerWidth;canvas.height=window.innerHeight;}
resizeCanvas();window.addEventListener('resize',resizeCanvas);
const letters='ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-=+/<>*';const fontSize=16;
let columns=Math.floor(canvas.width/fontSize);let drops=new Array(columns).fill(0);
function drawMatrix(){ctx.fillStyle='rgba(0,0,0,0.05)';ctx.fillRect(0,0,canvas.width,canvas.height);
ctx.fillStyle='#0f0';ctx.font=fontSize+'px monospace';
for(let i=0;i<drops.length;i++){const text=letters.charAt(Math.floor(Math.random()*letters.length));
ctx.fillText(text,i*fontSize,drops[i]*fontSize);if(drops[i]*fontSize>canvas.height){drops[i]=0;}else{drops[i]++;}}}
setInterval(drawMatrix,35);
</script>

<!-- Libraries -->
<script src="pdf.js"></script>
<script src="pdf.worker.min.js"></script>
<script src="mammoth.browser.min.js"></script>
<script src="docx-preview.min.js"></script>
<script src="webodf.js"></script>
<script src="xlsx.full.min.js"></script>
<script src="jszip.min.js"></script>
<script src="pptxjs.min.js"></script>
<script src="pptxjs-viewer.js"></script>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc='pdf.worker.min.js';

const fileInput=document.getElementById('fileInput');
const pdfCanvas=document.getElementById('pdfCanvas');
const docOutput=document.getElementById('docOutput');
const docxContainer=document.getElementById('docxContainer');
const odtContainer=document.getElementById('odtContainer');
const pptxContainer=document.getElementById('pptxContainer');
const ctxPDF=pdfCanvas.getContext('2d');
const errorBox=document.getElementById('errorBox');
const viewerContainer=document.getElementById('viewerContainer');
const fullscreenBtn=document.getElementById('fullscreenBtn');
const uploadBar=document.getElementById('uploadBar');

let currentPdf=null; let currentPdfPage=null; let pdfScale=1.0; let isFullscreen=false; let currentDocType=null;

function showError(msg){errorBox.style.display='block';errorBox.textContent=msg;
fullscreenBtn.style.display='none';setTimeout(()=>{errorBox.style.display='none';},5000);}

// PDF render helper
async function renderPdfPreview(page, containerWidth, containerHeight){
  const viewport=page.getViewport({scale:1});
  const scale=Math.min(containerWidth/viewport.width, containerHeight/viewport.height);
  const scaledViewport=page.getViewport({scale:scale});
  pdfCanvas.width=scaledViewport.width;
  pdfCanvas.height=scaledViewport.height;
  await page.render({canvasContext:ctxPDF, viewport:scaledViewport}).promise;
}

async function renderPdfPage(page, scale){
  const viewport=page.getViewport({scale:scale});
  pdfCanvas.width=viewport.width; pdfCanvas.height=viewport.height;
  await page.render({canvasContext:ctxPDF, viewport:viewport}).promise;
}

// DOCX
function renderDocx(arrayBuffer){
  docxContainer.innerHTML='';
  const docx = new docxPreview.Viewer(docxContainer, { 
    className: 'docViewer', 
    style: 'border:2px solid #333; border-radius:12px;' 
  });
  docx.load(arrayBuffer);
}

// PPTX
function renderPptx(arrayBuffer){
  pptxContainer.innerHTML='';
  const pptx = new PPTXViewer(pptxContainer);
  pptx.load(arrayBuffer);
}

// Upload Handling
fileInput.addEventListener('change', async e => {
  const file = e.target.files[0]; if(!file) return;
  viewerContainer.style.display='flex';
  [pdfCanvas, docOutput, docxContainer, odtContainer, pptxContainer].forEach(el=>el.style.display='none');

  const reader = new FileReader();
  reader.onload = async () => {
    const name = file.name.toLowerCase();
    try {
      if(name.endsWith('.pdf')){
        currentDocType="pdf"; pdfCanvas.style.display='block';
        const pdf = await pdfjsLib.getDocument({data:new Uint8Array(reader.result)}).promise;
        const page = await pdf.getPage(1);
        currentPdf = pdf; currentPdfPage = page; pdfScale=1.0;
        const containerWidth=viewerContainer.clientWidth-20;
        const containerHeight=viewerContainer.clientHeight-20;
        await renderPdfPreview(page, containerWidth, containerHeight);

      } else if(name.endsWith('.docx')){
        currentDocType="docx"; docxContainer.style.display='block';
        renderDocx(reader.result);

      } else if(name.endsWith('.odt')){
        currentDocType="odt"; odtContainer.style.display='block'; odtContainer.innerHTML='';
        const odfCanvas=new odf.OdfCanvas(odtContainer);
        const blob=new Blob([reader.result],{type:"application/vnd.oasis.opendocument.text"});
        const url=URL.createObjectURL(blob); await odfCanvas.load(url);

      } else if(name.endsWith('.xlsx')||name.endsWith('.ods')){
        currentDocType="xls"; docOutput.style.display='block'; docOutput.innerHTML='';
        const wb=XLSX.read(reader.result,{type:'array'});
        wb.SheetNames.forEach(sheet=>{
          const html=XLSX.utils.sheet_to_html(wb.Sheets[sheet]);
          const div=document.createElement('div'); div.innerHTML=html; docOutput.appendChild(div);
        });

      } else if(name.endsWith('.pptx')){
        currentDocType="ppt"; pptxContainer.style.display='block';
        renderPptx(reader.result);

      } else if(name.endsWith('.txt')){
        currentDocType="txt"; docOutput.style.display='block';
        const textDecoder=new TextDecoder("utf-8");
        docOutput.textContent=textDecoder.decode(reader.result);

      } else {showError('Format nicht unterstützt'); return;}
      fullscreenBtn.style.display='flex';
    } catch(err){ showError(err.message); console.error(err); }
  };
  reader.readAsArrayBuffer(file);
});

// Fullscreen Toggle
fullscreenBtn.addEventListener('click', async () => {
  if(!isFullscreen){
    viewerContainer.style.position='fixed';
    viewerContainer.style.top='0';
    viewerContainer.style.left='0';
    viewerContainer.style.width='100vw';
    viewerContainer.style.height='100vh';
    viewerContainer.style.overflow='auto';
    uploadBar.style.display='none';
    if(currentDocType==="pdf" && currentPdfPage){
      await renderPdfPage(currentPdfPage,1.0);
    }
    isFullscreen=true;
  } else {
    viewerContainer.style.position='relative';
    viewerContainer.style.width='90%';
    viewerContainer.style.height='80%';
    viewerContainer.style.maxWidth='90%';
    viewerContainer.style.maxHeight='80%';
    viewerContainer.style.overflow='hidden';
    uploadBar.style.display='flex';
    if(currentDocType==="pdf" && currentPdfPage){
      const containerWidth=viewerContainer.clientWidth-20;
      const containerHeight=viewerContainer.clientHeight-20;
      await renderPdfPreview(currentPdfPage, containerWidth, containerHeight);
    }
    isFullscreen=false;
  }
});
</script>
</body>
</html>
